Документация по API «Нью-Тел»

Версия этого документа: непубличный документ (БЕТА-версия от 03.05.21).

Данный документ описывает возможности взаимодействия с API «Нью-Тел», доступные
всем зарегистрированным абонентам, у которых подключена услуга «Интеграция +
API/Webhooks».

Для осуществления взаимодействия с API у сотрудника компании-абонента «Нью-Тел»
должны быть сформированы индивидуальные ключи для авторизации и подписи запросов
к API-серверу. Операции с этими ключами можно производить в личном кабинете
«Нью-Тел».

# Описание протокола

1.  Запросы к API «Нью-Тел» осуществляются посредством протокола HTTPS на адрес:
    https://api.new-tel.net/

2.  API-сервер обрабатывает только запросы с методом POST, следуя спецификации
    HTTP/1.1

3.  Параметры запроса передаются в теле сообщения в формате:

application/json или application/x-www-form-urlencoded

1.  Строка параметров запроса должна быть сформирована в кодировке UTF-8 без
    дополнительных пробелов и переносов строк. Например, в PHP это можно сделать
    методами: json_encode(\$params) или http_build_query(\$params),

    где: \$params – ассоциативный массив параметров или объект;

2.  Формат данных запроса должен быть указан в заголовке: Content-Type

3.  Корректная длина сообщения должна быть указана в заголовке: Content-Length

4.  Ответные данные возвращаются всегда в кодировке UTF-8. Формат данных может
    быть указан в заголовке Accept, где допускаются следующие значения:

    application/json – для ответа в формате JSON;

    application/xml – для ответа в формате XML;

    В случае отсутствия в запросе заголовка Accept данные возвращаются в формате
    JSON.

Примечание: в данной документации все примеры ответов API-сервера
отформатированы с добавлением пробелов и переводов строк для лучшей читаемости.

## Аутентификация и авторизация

В текущей версии API классическая аутентификация и авторизация замещена
хешированием всех запросов со стороны клиента при обращении на сервер.

Для этого используются ключ доступа к API-серверу, подпись запроса, метки даты и
времени.

Ключ доступа к API-серверу и подпись запроса необходимо взять в личном кабинете
«Нью-Тел».

За счет того, что ключ доступа является уникальным идентификатором клиента
«Нью-Тел» и содержится в каждом запросе к серверу, на стороне сервера
производится однозначное сопоставление между запросом и клиентом, от которого
этот самый запрос пришел. Происходит это при проверке хеш суммы ключа запроса на
стороне сервера.

Для этого каждый запрос должен содержать заголовок:

Authorization: Bearer ключ_запроса

где: ключ_запроса – это строка длиной 122 символа, полученная соединением ключа
доступа к API-серверу с меткой времени запроса и вычисленной подписью запроса.

Ключ доступа к API-серверу представляет собой строку из 48-и шестнадцатеричных
цифр в нижнем регистре (десятичных цифр и латинских букв «a», «b», «c», «d», «e»
и «f»). Этот ключ необходимо взять в личном кабинете «Нью-Тел».

Метка времени запроса передаётся в виде Unix timestamp и представляет собой
строку, состоящую из 10-и десятичных цифр. Для прохождения аутентификации и
авторизации все запросы должны иметь метку времени в пределах ±10 минут от
текущего времени.

Подпись запроса состоит из 64-х шестнадцатеричных цифр в нижнем регистре,
которые являются текстовым представлением результата хеширования по алгоритму
SHA-256 от объединения в указанном порядке следующих данных: строки с
наименованием метода, метки времени запроса, ключа API для авторизации запросов,
строки параметров запроса и ключа API для подписи запросов, между которыми
вставлен символ новой строки (0x0A или "\\n").

Пример успешного запроса к серверу приведен ниже.

\<?php

\$dataArr = '';

\#for (\$i = 1; \$i \<= 500; \$i++) {

\$data = json_encode(\$dataArr);

var_dump(\$data);

\$time = time();

\$resId = curl\_init();

\$key = getKey('company/get-state',

\$time,

'616a2cbbc392c798c06161dae2bd0c2093af4f399e95f48d',

\$data,

'84c29e3807ccb092f50ea7e66537ba9b519628efdd741046');

curl_setopt\_array(\$resId, [

CURLINFO_HEADER_OUT =\> true,

CURLOPT_HEADER =\> 0,

CURLOPT_HTTPHEADER =\> [

'Authorization: Bearer '.\$key ,

'Content-Type: application/json' ,

],

CURLOPT_POST =\> true,

CURLOPT_RETURNTRANSFER =\> true,

CURLOPT_SSL_VERIFYPEER =\> false,

CURLOPT_URL =\> 'https://api.new-tel.net/company/get-state',

CURLOPT_POSTFIELDS =\> \$data,

]);

\$response = curl_exec(\$resId);

\$curlInfo = curl_getinfo(\$resId);

sleep(1);

var_dump(\$response);

\#}

function getKey (\$methodName , \$time , \$keyNewtel , \$params , \$writeKey ) {

//var_dump(\$methodName."\\n".\$time."\\n".\$keyNewtel."\\n".\$params."\\n".\$writeKey);

return \$keyNewtel.\$time.hash( 'sha256' ,
\$methodName."\\n".\$time."\\n".\$keyNewtel."\\n".\$params."\\n".\$writeKey);

}

## Параметры ответа

При формировании ответа API-сервер устанавливает соответствующие HTTP-статусы и
заголовки. В теле ответа возвращается объект, обязательно содержащий свойство
status, отображающее результат обработки запроса API-сервером, строка с одним из
значений:

"success" – обработка запроса прошла успешно (аутентификация и авторизация
произведены, запрашиваемый метод существует, все необходимые параметры
присутствуют и валидны);

"error" – при обработке запроса произошла ошибка.

Если при обработке запроса произошла ошибка, объект в теле ответа будет также
содержать свойство message, в котором будет находиться текстовое описание
ошибки. При этом будет установлен соответствующий HTTP-статус. Например, при
корректном запросе, отправленном на адрес несуществующего метода, будет
установлен HTTP-статус “404 Not Found” и сформирован ответ:

{

"status": "error",

"message": "Requested method not found"

}

При успешной обработке запроса будет установлен HTTP-статус “200 OK” и объект в
теле ответа будет содержать объект data, обязательно содержащий свойство result,
отображающее результат работы запрашиваемого метода, строка с одним из значений:

"success" – запрашиваемый метод успешно выполнен;

"error" – при выполнении метода возникла ошибка.

Если запрашиваемый метод подразумевает возврат данных, то при успешном
выполнении метода объект data будет также содержать указанное в описании метода
свойство, массив или объект, где будут находиться ответные данные.

Например, при корректном запросе, отправленном на адрес:
'https://api.new-tel.net/company/get-state формируется ответ:

string(2) """" string(161) "

{

"status":"success",

"data":{

"result":"success",

"state":{"balance":97.93,

"credit":0,

"currency":"RUB",

"dayTrafficCost":0,

"monthTrafficCost":0,

"status":"active"

}

}

}"

Если при выполнении метода возникла ошибка, объект data будет также содержать
свойство message, в котором будет находиться текстовое описание ошибки.
Возможные ситуации возникновения ошибки и соответствующие сообщения перечислены
в описании методов.

Пример ответа, при котором возникла ошибка при выполнении метода:

{

"status": "success",

"data": {

"result": "error",

"message": "Error occured"

}

}

## Подпись ответа

Клиентская сторона может проверять достоверность получаемых данных, сверяя
подпись ответа. Подпись ответа вычисляется по алгоритму, аналогичному для
вычисления подписи запроса, где вместо строки параметров запроса используется
текстовый контент ответного HTTP-сообщения. Результат вычисления отправляется в
текстовом виде с HTTP-заголовком: Signature.

ВАЖНО: со стороны API-сервера подписываются только ответы на авторизованные
запросы с корректной подписью!

## Пример кода на PHP

Пример кода на PHP формирования запроса для осуществления соединения между
номерами  
\+7 904 111-22-33 и +7 999 111-22-33 с отображением номера +7 495 111-22-33 при
вызовах:

\<?php

// функция для вычисления ключа запроса

function getRequestKey(\$methodName, \$time, \$accessKey, \$params,
\$signatureKey)

{

return \$accessKey . \$time . hash('sha256',

\$methodName . "\\n" .

\$time . "\\n" .

\$accessKey . "\\n" .

\$params . "\\n" .

\$signatureKey

);

}

\$data = json\_encode([

'callerId' =\> ‘74951112233’,

'dstNumber' =\> '79041112233',

'srcNumber' =\> '79991112233',

'timeout' =\> 30,

]);

\$time = time();

\$resId = curl\_init();

\$requestKey = getRequestKey(

'call/start-simple-call', // наименование метода

\$time, // метка времени запроса

'1234567890abcdef1234567890abcdef1234567890abcdef', // ключ авторизации

\$data, // строка параметров запроса

'abcdef1234567890abcdef1234567890abcdef1234567890' // ключ подписи

);

curl_setopt\_array(\$resId, [

CURLINFO_HEADER_OUT =\> true,

CURLOPT_HEADER =\> 0,

CURLOPT_HTTPHEADER =\> [

'Authorization: Bearer ' . \$requestKey,

'Content-Type: application/json',

],

CURLOPT_POST =\> true,

CURLOPT_RETURNTRANSFER =\> true,

CURLOPT_SSL_VERIFYPEER =\> false,

CURLOPT_URL =\>'https://api.new-tel.net/call/start-simple-call',

CURLOPT_POSTFIELDS =\> \$data,

]);

\$response = curl_exec(\$resId);

\$curlInfo = curl_getinfo(\$resId);

## Дополнительные требования

1.  Клиентская сторона должна проверять корректность SSL-сертификата сервера, и,
    если SSL-сертификат не прошёл проверку, следует немедленно прекратить сессию
    во избежание утечки данных.

2.  Ключи для взаимодействия с API не должны храниться в открытом виде,
    например, в cookie.

История изменений документа

03.05.21 – переписан раздел «Аутентификации и авторизация»
